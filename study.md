Antlr4
语言由一系列有意义的语句组成，语句由词组和规则组成，词组又由词符号组成。对于一个输入，比如“sp=100"，
我们需要将其识别为一个赋值语句，意味着需要知道sp是被赋值的目标，100是要被赋予的值，成功识别后，方能进行适当的操作。

在识别过程中，我们首先需要将字符聚集为单词或符号（词法符号，token)，这个过程称为`词法分析`
进行词法分析的程序或者函数叫作`词法分析器`（lexical analyzer，简称lexer）
，也叫扫描器（scanner）。`词法分析器一般以函数的形式存在`，供语法分析器调用。

词法分析完成后，需要将这些单词或符号，根据语法规则，识别为有意义的语句，这个过程称为`语法分析`
语法分析器（parser）它的作用是进行语法检查、并构建由输入的单词组成的数据结构（一般是语法分析树、抽象语法树等层次化的数据结构）。
语法分析器通常使用一个独立的词法分析器从输入字符流中分离出一个个的“单词”，并将单词流作为其输入。

ANTLR（全称：ANother Tool for Language Recognition）是目前非常流行的语言识别工具，使用Java语言编写，
基于LL(*)解析方式，使用自上而下的递归下降分析方法。
通过输入语法描述文件来自动构造自定义语言的词法分析器、语法分析器和树状分析器等各个模块。
ANTLR使用上下无关文法描述语言，文法定义使用类似EBNF的方式。

所有编程语言的语法，都可以用ANTLR来定义。ANTLR提供了大量的官方grammar示例，包含了各种常见语言，
比如Java、SQL、Javascript、PHP等等。ANTLR的应用非常广泛，比如Hive、Presto和SparkSQL等的SQL Parser模块
都是基于ANTLR构建的。



Antlr语法
语法模式
语言纷繁复杂，但是对其进行抽象，可以分为以下四种模式：

序列模式，即一系列元素
选择模式，在多个可选方案中做出选择
词法符号依赖，一个词法符号需要和某处的另外一个词法符号配对
嵌套结构，一种自相似的语言结构。

序列模式

它是一个任意长的，可能为空的序列，其中的元素可以是词法符号或者子规则。序列模式的例子包括变量声明和整数序列等等，比如：

'[' INT+ ']'  //Matlab的整数向量
带终止符的序列模式

它是一个任意长的，可能为空的序列，该序列由一个词法符号分隔开，通常是分号或换行符，其中的元素可以是词法符号或者子规则。这样的例子包括类C语言的语句集合和一些用换行符来分隔的数据格式。比如：

（statement ';')*  //java的语句集合
（row '\n')* //多行数据


带分隔符的序列模式

它是一个任意长的，可能为空的序列，该序列由一个词法符号分隔开，通常是逗号，分号或句号，其中的元素可以是词法符号或者子规则。这样的例子包括函数定义的参数列表，函数调用时传递的参数列表、某些语句之间有分隔符却无终止符的编程语言。

函数调用的参数列表中找到这样的例子：

exprList: expr(',' expr)* 


选择模式

它是一组备选分支的集合。使用｜来分隔同一个语言规则的若干备选分支。这样的例子包括不同种类的类型、语句、表达式或者XML标签。比如下面这个字段定义表达式：

field：INT | STRING；  //允许子段中出现整数或者字符串


词法符号依赖模式

一个词法符号需要和一个或多个后续词法符号匹配。这样的例子包括配对的圆括号，花括号，方括号和尖括号。

比如对于整数向量序列[1,2,3]这种，为了描述向量左右两侧的方括号，需要一种方法来表达对这样的词法符号的依赖。此时，如果我们在一个语句中看到一个符号，那么就必须在语句中找到另一个配对的符号。为表达出这种语意，在语法中，使用一个序列来指明所有配对的符号，通常这些符号会把其他元素分组或包裹起来。

比如，对于一个整数向量，可以用这种方式表示：

vector: '[' INT+ ']' ;  //[1], [1,2], [1,2,3],...



以方法定义为例，它的语法表示如下：

functionDecl
: type ID '{' formalParameters? '}'
;
formalParameters
: formalParameter (',' formalParameter)*
;
formalParameter
: type ID


嵌套模式

它是一种子相似的语言结构。这样的例子包括表达式，Java的内部类、嵌套的代码块以及嵌套的Python函数定义。

比如嵌套数组表达式定义：

expr: ID '[' expr ']'  //a[1],a[b[1]],a[(2*b[1])]
| '(' expr ')'  //(1),(a[1]),(((1))),(2*a[1])
| INT
;
再比如类定义：

classDef:
: 'calss' ID '{' (calssDef|method|field) '}' ;



Antlr4语法中，支持的关键字有：import, fragment, lexer, parser, grammar, returns, locals, throws, catch, finally, mode, options, tokens。



开发步骤
使用ANTLR4编程的基本流程是固定的，通常分为如下三步：

基于需求按照ANTLR4的规则编写自定义语法的语义规则, 保存成以g4为后缀的文件。
使用ANTLR4工具处理g4文件，生成词法分析器、句法分析器代码、词典文件。
编写代码继承Visitor类或实现Listener接口，开发自己的业务逻辑代码。


基于ANTLR4的规则定义语法文件，文件名以g4为后缀。例如实现计算器的语法规则文件命名为Calculator.g4。其内容如下：

```text
grammar Calculator;

/** 起始规则 语法分析器起点 */
expr:	expr op=('*'|'/') expr  # MulDiv
|	expr op=('+'|'-') expr  # AddSub
|	INT                     # int
|	'(' expr ')'            # parens
;

INT     : [0-9]+ ;      // 匹配整数

MUL     : '*' ;
DIV     : '/' ;
Add     : '+' ;
SUB     : '-' ;
```


计算器能力扩展
上面是一个最简单版本的计算器，只支持Int类型，不支持浮点数运算，下面对其进行扩展。
语法定义整数和小数：
```
number
: INT | DECIMAL
;

decimal
: INT DOT INT
；

INT     : [0-9]+ ;
DOT     : '.';
此时完整的语法文件如下：
```

```
grammar Calculator;

/** 起始规则 语法分析器起点 */
expr:   expr op=('*'|'/') expr  # MulDiv
|   expr op=('+'|'-') expr  # AddSub
|   number                  # num
|   '(' expr ')'            # parens
;

number
: INT | decimal
;

decimal
: INT DOT INT
;

INT     : [0-9]+ ;
DOT     : '.';

MUL     : '*' ;
DIV     : '/' ;
Add     : '+' ;
SUB     : '-' ;
```


SQL执行一般分为五步：

第一步：SQL改写（这个一般不是必须的）；
第二步：SQL Parser，将其转化为AST;
第三步：转化为逻辑执行计划；
第四步：对执行计划进行优化；
第五步：转换为物理执行计划，执行；
可以看到，在整个执行过程中，SQL Parser是必不可少的一部分。









